"use strict";(self.webpackChunklark_mermaid_addon=self.webpackChunklark_mermaid_addon||[]).push([[792],{1237(w,U,u){var o=u(4848),p=u(6540),b=u(961),j=u(5862);const N=["graph ",`graph
`,"flowchart ",`flowchart
`,"sequenceDiagram","classDiagram","stateDiagram","erDiagram","journey","gantt","pie ","quadrantChart","requirementDiagram","gitGraph","mindmap","timeline","zenuml","sankey","xychart","block-beta"];function F(n){const e=n.trim();return N.some(a=>e.startsWith(a))}function z(n){let e=n.replace(/［/g,"[").replace(/］/g,"]").replace(/（/g,"(").replace(/）/g,")").replace(/｛/g,"{").replace(/｝/g,"}").replace(/＜/g,"<").replace(/＞/g,">").replace(/：/g,":").replace(/；/g,";").replace(/，/g,",").replace(/｜/g,"|");return e=e.replace(/\u201C/g,"#quot;").replace(/\u201D/g,"#quot;"),e=e.replace(/\u2018/g,"#apos;"),e=e.replace(/\[([^\]]*)\]/g,(a,r)=>"["+r.replace(/"/g,"#quot;")+"]"),e}const A=500,M=2;function L(n){return new Promise((e,a)=>{const t=new DOMParser().parseFromString(n,"image/svg+xml").documentElement;let s=parseFloat(t.getAttribute("width")||"0"),i=parseFloat(t.getAttribute("height")||"0");const c=t.getAttribute("viewBox");if(c&&(!s||!i)){const d=c.split(/[\s,]+/);d.length===4&&(s=parseFloat(d[2])||800,i=parseFloat(d[3])||600)}if(s||(s=800),i||(i=600),s>A){const d=A/s;i=Math.round(i*d),s=A}t.setAttribute("width",String(s)),t.setAttribute("height",String(i));const g=new XMLSerializer().serializeToString(t),y=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(g)))}`,m=new Image;m.onload=()=>{const d=document.createElement("canvas");d.width=s*M,d.height=i*M;const h=d.getContext("2d");h.fillStyle="#ffffff",h.fillRect(0,0,d.width,d.height),h.scale(M,M),h.drawImage(m,0,0,s,i);const B=d.toDataURL("image/png");e({dataUrl:B,width:s,height:i})},m.onerror=()=>{a(new Error("Failed to load SVG as image"))},m.src=y})}var x=(n,e,a)=>new Promise((r,l)=>{var t=c=>{try{i(a.next(c))}catch(v){l(v)}},s=c=>{try{i(a.throw(c))}catch(v){l(v)}},i=c=>c.done?r(c.value):Promise.resolve(c.value).then(t,s);i((a=a.apply(n,e)).next())});let D=null,$=null,P=0;function T(){return x(this,null,function*(){return D||($||($=(()=>x(this,null,function*(){const{default:n}=yield u.e(121).then(u.bind(u,9465)),{mermaidConfig:e}=yield u.e(716).then(u.bind(u,9716));n.initialize(e),D=n}))()),yield $,D)})}function R(n,e){var a,r;const l=[];if(n.type===j._B.CODE&&e){const t=(r=(a=n.data)==null?void 0:a.plain_text)!=null?r:"";t&&F(t)&&l.push({snapshot:n,parentSnapshot:e,code:t})}if(n.childSnapshots)for(const t of n.childSnapshots)l.push(...R(t,n));return l}function H(){const[n,e]=(0,p.useState)("idle"),[a,r]=(0,p.useState)(""),[l,t]=(0,p.useState)([]),s=(0,p.useRef)(null);function i(){return s.current||(s.current=new j.MN().initAPI()),s.current}const c=(0,p.useCallback)(()=>x(this,null,function*(){e("scanning"),r("Scanning document..."),t([]);try{const g=i(),I=yield g.getActiveDocumentRef(),y=yield g.Document.getRootBlock(I),m=R(y,null);if(m.length===0){e("done"),r("No mermaid code blocks found.");return}e("rendering"),r(`Rendering ${m.length} block(s)...`);const d=yield T(),h=[];for(const f of m)try{const S=z(f.code.trim()),C=`mermaid-preview-${Date.now()}-${++P}`,{svg:E}=yield d.render(C,S),{dataUrl:V,width:X,height:K}=yield L(E);h.push({code:f.code,svg:E,dataUrl:V,width:X,height:K,snapshot:f.snapshot,parentSnapshot:f.parentSnapshot})}catch(S){const C=S instanceof Error?S.message:String(S);h.push({code:f.code,svg:"",dataUrl:"",width:0,height:0,snapshot:f.snapshot,parentSnapshot:f.parentSnapshot,error:C})}t(h),e("done");const B=h.filter(f=>!f.error).length,k=h.filter(f=>f.error).length;r(`Found ${B} diagram(s)${k?`, ${k} failed to render`:""}.`)}catch(g){e("error"),r(g instanceof Error?g.message:"Failed to scan document"),console.error("[Mermaid] Scan error:",g)}}),[]),v=(0,p.useCallback)(()=>x(this,null,function*(){const g=l.filter(h=>!h.error);if(g.length===0)return;e("inserting"),r(`Inserting ${g.length} diagram(s)...`);const I=i();let y=0,m=0;const d=[...g].reverse();for(let h=0;h<d.length;h++){const B=d[h];try{yield O(I,B,h),y++,r(`Inserted ${y}/${g.length}...`)}catch(k){m++,console.error("[Mermaid] Insert error:",k)}}e("done"),r(m===0?`Inserted ${y} diagram(s) into document.`:`${y} inserted, ${m} failed.`)}),[l]);return(0,p.useEffect)(()=>{c()},[c]),{status:n,message:a,blocks:l,scan:c,insertAll:v}}function O(n,e,a){return x(this,null,function*(){const r=e.parentSnapshot.ref,l=e.snapshot.childIndex+1;try{yield n.Document.insertBlocksByHTML(e.snapshot.ref,`<img src="${e.dataUrl}" width="${e.width}" height="${e.height}" alt="Mermaid diagram" />`);return}catch(t){console.warn("[Mermaid] insertBlocksByHTML failed:",t)}try{const t=W(e.dataUrl,`mermaid-${a+1}.png`);yield n.Block.ImageBlock.insertByUploadImage(r,l,t);return}catch(t){console.warn("[Mermaid] insertByUploadImage failed:",t)}try{yield n.Document.insertBlocksByMarkdown(`![Mermaid Diagram](${e.dataUrl})`,e.snapshot.ref);return}catch(t){console.warn("[Mermaid] insertBlocksByMarkdown failed:",t)}try{yield n.Document.insertBlocksByHTML(e.snapshot.ref,e.svg);return}catch(t){console.warn("[Mermaid] insertBlocksByHTML SVG failed:",t)}try{const t=yield n.Service.Preview.uploadImage({dataUrl:e.dataUrl,filename:`mermaid-${a+1}.png`,width:e.width,height:e.height});yield n.Block.insertBlock(r,l,{type:j._B.IMAGE,data:{token:(t==null?void 0:t.token)||t,width:e.width,height:e.height}});return}catch(t){console.warn("[Mermaid] Preview.uploadImage failed:",t)}throw new Error("All image insertion strategies failed.")})}function W(n,e){var a;const[r,l]=n.split(","),t=((a=r.match(/:(.*?);/))==null?void 0:a[1])||"image/png",s=atob(l),i=new Uint8Array(s.length);for(let c=0;c<s.length;c++)i[c]=s.charCodeAt(c);return new File([i],e,{type:t})}function G(){const{status:n,message:e,blocks:a,scan:r,insertAll:l}=H(),t=n==="scanning"||n==="rendering"||n==="inserting",s=a.filter(i=>!i.error).length>0;return(0,o.jsxs)("div",{className:"panel",children:[(0,o.jsxs)("div",{className:"panel-header",children:[(0,o.jsxs)("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"#6366f1",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,o.jsx)("rect",{x:"3",y:"3",width:"7",height:"7"}),(0,o.jsx)("rect",{x:"14",y:"3",width:"7",height:"7"}),(0,o.jsx)("rect",{x:"14",y:"14",width:"7",height:"7"}),(0,o.jsx)("rect",{x:"3",y:"14",width:"7",height:"7"})]}),(0,o.jsx)("span",{className:"panel-title",children:"Mermaid Renderer"})]}),(0,o.jsxs)("div",{className:"panel-body",children:[e&&(0,o.jsxs)("div",{className:`status ${n}`,children:[t&&(0,o.jsx)("span",{className:"spinner"}),(0,o.jsx)("span",{children:e})]}),(0,o.jsxs)("div",{className:"actions",children:[(0,o.jsx)("button",{className:"action-btn scan-btn",onClick:r,disabled:t,children:t&&n!=="inserting"?"Scanning...":"Rescan"}),s&&(0,o.jsx)("button",{className:"action-btn insert-btn",onClick:l,disabled:t,children:n==="inserting"?"Inserting...":"Insert into Document"})]})]})]})}b.render((0,o.jsx)(p.StrictMode,{children:(0,o.jsx)(G,{})}),document.getElementById("root"))}},w=>{var U=o=>w(w.s=o);w.O(0,[121],()=>U(1237));var u=w.O()}]);
